target_default: 9_collaborator_data

packages:
  - sf
  - tidyverse
  - lwgeom
  - smoothr
  - geojsonio
  - geojsonsf
  - ggplot2

sources:
  - 1_network/src/calc_distance_functions.R
  - 1_network/src/geo_fabric_functions.R
  - 2_observations/src/data_munge_functions.R
  - 9_collaborator_data/src/makerspace_geojson.R
  - 9_collaborator_data/src/write_functions.R
  - 9_collaborator_data/src/psu_site_selection.R
  - 9_collaborator_data/src/subset_sntemp_preds.R

targets:
  9_collaborator_data:
    depends:
     - 9_collaborator_data/mkrsp/delaware_sites_summary.geojson.ind
     - 9_collaborator_data/umn/network_subset.rds.ind
     - 9_collaborator_data/umn/distance_matrix.rds.ind
     - 9_collaborator_data/umn/distance_matrix.npz.ind
     - 9_collaborator_data/umn/distance_matrix_subset.npz.ind
     - 9_collaborator_data/umn/obs_temp_full.csv.ind
     - 9_collaborator_data/umn/obs_temp_subset.csv.ind
     - 9_collaborator_data/umn/obs_flow_full.csv.ind
     - 9_collaborator_data/umn/obs_flow_subset.csv.ind
     - 9_collaborator_data/psu/highly_observed_sites.csv.ind
     - 9_collaborator_data/psu/highly_obs_distance_matrix.csv.ind
     - 9_collaborator_data/psu/highly_obs_distance_heatmap.png
     - 9_collaborator_data/psu/sntemp_preds_aggregated.feather.ind
     - 9_collaborator_data/psu/temp_obs_high_obs_sites.csv.ind
     - 9_collaborator_data/psu/flow_obs_high_obs_sites.csv.ind


  ##### Makerspace #####
  # generate file to load for map (http://delaware-basin-test-website.s3-website-us-west-2.amazonaws.com/)

  9_collaborator_data/mkrsp/delaware_sites_summary.rds.ind:
    command: generate_site_summary(
      out_ind = target_name,
      dat_ind = '2_observations/out/all_drb_temp_obs.rds.ind',
      crosswalk_ind = '2_observations/out/crosswalk_site_reach.rds.ind')

  9_collaborator_data/mkrsp/delaware_sites_summary.rds:
    command: gd_get('9_collaborator_data/mkrsp/delaware_sites_summary.rds.ind')

  # convert summary to geojson

  9_collaborator_data/mkrsp/delaware_sites_summary.geojson.ind:
    command: generate_site_geojson(summary_ind = '9_collaborator_data/mkrsp/delaware_sites_summary.rds.ind', out_ind = target_name)

  9_collaborator_data/mkrsp/delaware_sites_summary.geojson:
    command: gd_get('9_collaborator_data/mkrsp/delaware_sites_summary.geojson.ind')

  ###### University of Minnesota #####
  # also should include:
    # 1_network/out/network.rds
    # 2_observations/out/basin_temp_data.rds

  # subset network segments and then distance matrix to only those reaches whose outlets match up with
  # SNTemp prediction points, because these are the reaches we'll have SNTemp driver data for, and
  # for the purpose of the neural networks, the distance matrix is the only representation of network
  # connectivity, so once we have it correct (by doing the network corrections in 1_network)
  # we can safely subset to only the sntemp segmentsand still have a connected network. This effectively
  # treats the reaches that were split into 2 reaches as now being 1 reach again (appropriate because
  # that's what the inputs from SNTemp into the NN will describe).
  9_collaborator_data/umn/sntemp_segs.rds:
    command: select_sntemp_subsegs(
      network_ind = '1_network/out/network.rds.ind',
      out_rds = target_name)
  9_collaborator_data/umn/distance_matrix.rds.ind:
    command: subset_dist_to_subsegs(
      subsegs_rds = '9_collaborator_data/umn/sntemp_segs.rds',
      dist_ind = '1_network/out/subseg_distance_matrix.rds.ind',
      out_ind = target_name)
  9_collaborator_data/umn/distance_matrix.rds:
    command: gd_get('9_collaborator_data/umn/distance_matrix.rds.ind')

  # networks and distance matrices
  # npy version of distance matrix - this target seems to rebuild a few times if given the chance. huh.
  9_collaborator_data/umn/distance_matrix.npz.ind:
    command: save_dist_matrices(
      dist_mat_ind = '9_collaborator_data/umn/distance_matrix.rds.ind',
      out_ind = target_name)

  9_collaborator_data/umn/distance_matrix.npz:
    command: gd_get('9_collaborator_data/umn/distance_matrix.npz.ind')

  9_collaborator_data/umn/network_subset.rds.ind:
    command: make_subnetwork(
      out_ind = target_name,
      lower_reach = I('2748_1'),
      network_ind = '1_network/out/network.rds.ind',
      distance_ind = '1_network/out/subseg_distance_matrix.rds.ind',
      summary_ind = '9_collaborator_data/mkrsp/delaware_sites_summary.rds.ind')

  9_collaborator_data/umn/network_subset.rds:
    command: gd_get('9_collaborator_data/umn/network_subset.rds.ind')

  # create distance matrix of subset
  9_collaborator_data/umn/network_subset_sntemp_segs.rds:
    command: select_sntemp_subsegs(
      network_ind = '9_collaborator_data/umn/network_subset.rds.ind',
      out_rds = target_name)
  9_collaborator_data/umn/distance_matrix_subset.rds.ind:
    command: subset_dist_to_subsegs(
      subsegs_rds = '9_collaborator_data/umn/network_subset_sntemp_segs.rds',
      dist_ind = '1_network/out/subseg_distance_matrix.rds.ind',
      out_ind = target_name)

  9_collaborator_data/umn/distance_matrix_subset.rds:
    command: gd_get('9_collaborator_data/umn/distance_matrix_subset.rds.ind')

  # npy version of distance matrix_subset
  9_collaborator_data/umn/distance_matrix_subset.npz.ind:
    command: save_dist_matrices(dist_mat_ind = '9_collaborator_data/umn/distance_matrix_subset.rds.ind', out_ind = target_name)

  9_collaborator_data/umn/distance_matrix_subset.npz:
    command: gd_get('9_collaborator_data/umn/distance_matrix_subset.npz.ind')

  # temp data
  9_collaborator_data/umn/obs_temp_full.csv.ind:
    command: write_to_csv(dat_ind = '2_observations/out/obs_temp_drb.rds.ind', out_ind = target_name)

  9_collaborator_data/umn/obs_temp_full.csv:
    command: gd_get('9_collaborator_data/umn/obs_temp_full.csv.ind')

  9_collaborator_data/umn/obs_temp_subset.csv.ind:
    command: filter_subset(
      dat_ind = '2_observations/out/obs_temp_drb.rds.ind',
      subnet_ind = '9_collaborator_data/umn/network_subset.rds.ind',
      out_ind = target_name)

  9_collaborator_data/umn/obs_temp_subset.csv:
    command: gd_get('9_collaborator_data/umn/obs_temp_subset.csv.ind')

  # flow_data
  9_collaborator_data/umn/obs_flow_full.csv.ind:
    command: write_to_csv(dat_ind = '2_observations/out/obs_flow_drb.rds.ind', out_ind = target_name)

  9_collaborator_data/umn/obs_flow_full.csv:
    command: gd_get('9_collaborator_data/umn/obs_flow_full.csv.ind')

  9_collaborator_data/umn/obs_flow_subset.csv.ind:
    command: filter_subset(
      dat_ind = '2_observations/out/obs_flow_drb.rds.ind',
      subnet_ind = '9_collaborator_data/umn/network_subset.rds.ind',
      out_ind = target_name)

  9_collaborator_data/umn/obs_flow_subset.csv:
    command: gd_get('9_collaborator_data/umn/obs_flow_subset.csv.ind')

  #### Penn State ####
  9_collaborator_data/psu/highly_observed_sites.rds:
    command: filter_sites(
      out_file = target_name,
      dat_ind = '2_observations/out/obs_temp_drb.rds.ind',
      geo_dat = I('1_network/in/GeospatialFabric_National.gdb'),
      years = I(2),
      obs_per_year = I(150),
      min_drainage = I(100),
      max_drainage = I(10000))

  9_collaborator_data/psu/highly_observed_sites.csv.ind:
    command: write_sites(dat = '9_collaborator_data/psu/highly_observed_sites.rds', out_ind = target_name)

  9_collaborator_data/psu/highly_observed_sites.csv:
    command: gd_get('9_collaborator_data/psu/highly_observed_sites.csv.ind')

  9_collaborator_data/psu/highly_observed_map.png:
    command: map_highly_obs(
      out_file = target_name,
      cross_ind = '2_observations/out/crosswalk_site_reach.rds.ind',
      network_ind = '1_network/out/network.rds.ind',
      dat = '9_collaborator_data/psu/highly_observed_sites.rds',
      title = I('Sites with >=2 years with >150 obs'))

  # script to calculate keep sites is in psu_site_selection.R but is not formalized
  #keep_sites:
   # command: c("578_1", "580_1", "154_1", "269_1", "249_1", "250_1", "132_1", "16_1", "23_1")

  9_collaborator_data/psu/highly_obs_distance_matrix.rds.ind:
    command: subset_dist_to_subsegs(
      subsegs_rds = '9_collaborator_data/psu/highly_observed_sites.rds',
      dist_ind = '1_network/out/subseg_distance_matrix.rds.ind',
      out_ind = target_name)

  9_collaborator_data/psu/highly_obs_distance_matrix.rds:
    command: gd_get('9_collaborator_data/psu/highly_obs_distance_matrix.rds.ind')

  # this target builds a few times for some reason
  9_collaborator_data/psu/highly_obs_distance_matrix.csv.ind:
    command: write_distance(
      out_ind = target_name,
      dat = '9_collaborator_data/psu/highly_obs_distance_matrix.rds',
      dist_type = I('updown'))

  9_collaborator_data/psu/highly_obs_distance_matrix.csv:
    command: gd_get('9_collaborator_data/psu/highly_obs_distance_matrix.csv')

  9_collaborator_data/psu/highly_obs_distance_heatmap.png:
    command: dist_heatmap2(
      out_file = target_name,
      dist_ind = '9_collaborator_data/psu/highly_obs_distance_matrix.rds.ind',
      dist_type = I('updown'),
      labels = I('subseg_id'),
      title = I('Full Network - Upstream & Downstream'))

  9_collaborator_data/psu/high_obs_upstream_sites.csv:
    command: get_upstream_sites(
      out_file = target_name,
      dist_ind = '1_network/out/subseg_distance_matrix.rds.ind',
      network_ind = '1_network/out/network.rds.ind',
      sites = '9_collaborator_data/psu/highly_observed_sites.rds',
      out_file = target_name)

  9_collaborator_data/psu/sntemp_preds_high_obs_sites.feather.ind:
    command: subset_sntemp_preds(
      ind_file = target_name,
      sub_net_file = '9_collaborator_data/psu/high_obs_upstream_sites.csv',
      full_data_ind = '3_predictions/in/uncal_sntemp_input_output.feather.ind')
  9_collaborator_data/psu/sntemp_preds_high_obs_sites.feather:
    command: gd_get('9_collaborator_data/psu/sntemp_preds_high_obs_sites.feather.ind')

  9_collaborator_data/psu/sntemp_preds_aggregated.feather.ind:
    command: aggregate_sntemp_preds(
      ind_file = target_name,
      sub_net_file ='9_collaborator_data/psu/high_obs_upstream_sites.csv' ,
      subset_data_file = '9_collaborator_data/psu/sntemp_preds_high_obs_sites.feather')
  9_collaborator_data/psu/sntemp_preds_aggregated.feather:
    command: gd_get('9_collaborator_data/psu/sntemp_preds_aggregated.feather.ind')

  9_collaborator_data/psu/temp_obs_high_obs_sites.csv.ind:
    command: filter_obs(
      dat_ind = '2_observations/out/obs_temp_drb.rds.ind',
      subset = '9_collaborator_data/psu/highly_observed_sites.rds',
      out_ind = target_name)

  9_collaborator_data/psu/temp_obs_high_obs_sites.csv:
    command: gd_get('9_collaborator_data/psu/temp_obs_high_obs_sites.csv.ind')

  9_collaborator_data/psu/flow_obs_high_obs_sites.csv.ind:
    command: filter_obs(
      dat_ind = '2_observations/out/obs_flow_drb.rds.ind',
      subset = '9_collaborator_data/psu/highly_observed_sites.rds',
      out_ind = target_name)

  9_collaborator_data/psu/flow_obs_high_obs_sites.csv:
    command: gd_get('9_collaborator_data/psu/flow_obs_high_obs_sites.csv.ind')

